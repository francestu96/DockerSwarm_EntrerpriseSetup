version: "3.5"

networks:
  public:
    name: public
  private:
    name: private

services:
  database:
    image: mariadb
    hostname: database
    networks:
      - private
    environment:
      MYSQL_ROOT_PASSWORD: admin
      MYSQL_DATABASE: joomla
    volumes:
      - /gfs/db-volume/data:/var/lib/mysql

  phpmyadmin:
    image: custom-phpmyadmin:latest
    networks:
      - private
      - public
    environment:
      DB_HOST: database 
      DB_USER: root
      DB_PASSWORD: admin
    deploy:
      mode: global

  joomla: 
    image: custom-joomla:latest
    networks:
      - private
      - public
    volumes:
      - /gfs/joomla-volume/components:/var/www/html/components
      - /gfs/joomla-volume/administrator:/var/www/html/administrator
      - /gfs/joomla-volume/images:/var/www/html/images
    environment:
      DB_HOST: database
      DB_USER: root
      DB_PASSWORD: admin
      DB_NAME: joomla
      JOOMLA_ADMIN_USER: admin
      JOOMLA_ADMIN_PASS: admin
      JOOMLA_ADMIN_EMAIL: admin@admin.it
    deploy:
      mode: global
   
  prometheus:
    image: custom-prometheus:latest
    deploy:
      mode: global
    networks:
      - private

  grafana:
    image: custom-grafana:latest
    networks:
      - private
      - public
    volumes:
     - /gfs/grafana-volume/grafana.db:/var/lib/grafana/grafana.db
    deploy:
      mode: global

  proxy:
    image: custom-proxy:latest
    networks:
      - public
    ports:
      - 80:80
    deploy:
      mode: global  

  cadvisor:
    image: google/cadvisor
    volumes: 
      - /:/rootfs:ro
      - /var/run/:/var/run:rw
      - /sys/:/sys:ro
      - /var/lib/docker:/var/lib/docker:ro
    deploy:
      mode: global
    networks:
      - private

  node-exporter:
    image: prom/node-exporter
    deploy:
      mode: global
    networks:
      - private
